# 多用户与生产就绪能力说明

本文说明平台在「唯一身份识别、信息安全、个性化服务、权限管理、跨端同步」方面的实现与使用方式。

---

## 1. 唯一身份识别

**目标**：通过账号系统区分不同用户，确保数据归属清晰。

**实现**：

- **注册**：`POST /api/auth/register`，提交 `username`、`email`、`password`，后端创建用户并写入 `users` 表（含 `role`，默认 `user`）。
- **登录**：`POST /api/auth/login` 返回 JWT，其中包含 `user_id`，作为后续请求的身份依据。
- **鉴权**：受保护接口使用 `@token_required`，从 JWT 解析出 `current_user_id`，所有业务逻辑均基于该用户 ID。
- **企业归属**：企业通过 `user_company_favorites` 与用户绑定；用户仅能查看、操作自己「收藏/拥有」的企业（添加企业时自动写入该表）。

**使用**：不同账号登录后，企业列表、仪表盘、资讯、告警等均为各自数据，互不可见。

---

## 2. 信息安全

**目标**：个人数据独立存储，避免信息混乱或泄露。

**实现**：

- **按用户隔离**：
  - 企业列表：仅返回 `user_company_favorites` 中属于当前用户的企业。
  - 仪表盘：`/api/dashboard`、`/api/dashboard/trend`、`/api/dashboard/risk-distribution`、`/api/dashboard/category-distribution` 仅统计当前用户企业的数据。
  - 企业详情、更新、删除、爬虫触发：均校验该企业是否属于当前用户，否则返回 403。
  - 资讯列表、滚动资讯、搜索、告警、风险指标：仅限当前用户企业下的数据。
- **密码**：使用 Werkzeug `generate_password_hash` 存储，不存明文。
- **JWT**：使用服务端 `SECRET_KEY` 签名，生产环境请设置强密钥并限制过期时间。

**建议**：生产环境启用 HTTPS、合理设置 CORS、定期轮换 SECRET_KEY，并避免在日志中输出 token 或敏感参数。

---

## 3. 个性化服务

**目标**：保存用户偏好、历史记录，提供定制化体验。

**实现**：

- **用户设置**：`user_settings` 表按 `user_id` 存储（如搜索间隔、报告模板等）；`llm_config` 按用户存储 API 密钥与模型配置。
- **前端偏好**：主题色、语言等通过前端设置上下文（如 SettingsContext）持久化到本地存储，与账号无关；若需「随账号同步」可后续改为调用后端保存。
- **历史与收藏**：企业列表即用户添加/收藏的企业集合；收藏关系在 `user_company_favorites` 中，随账号持久化。

**扩展**：可在 `user_settings` 或新表中增加字段，存储更多偏好（如默认筛选条件、仪表盘布局等），并在前端读取/写入。

---

## 4. 权限管理

**目标**：为不同角色（如普通用户、管理员）分配差异化权限。

**实现**：

- **角色**：`users` 表有 `role` 字段，注册时默认 `user`；仅后端可写入 `admin`（注册接口会过滤非法 role，仅接受 `user`/`admin`）。
- **管理员接口**：`GET /api/admin/users` 使用 `@admin_required`，仅 `role=admin` 可访问，用于查看用户列表。
- **普通用户**：仅能访问自己的企业、资讯、仪表盘等；无法访问其他用户数据或管理接口。

**如何设置管理员**：在数据库中将对应用户的 `role` 更新为 `admin`，或通过预留的后台/脚本写入（不通过公开注册接口）。

---

## 5. 跨端同步

**目标**：支持多设备登录，数据实时同步。

**实现**：

- **无状态鉴权**：服务端不维护 session，仅校验 JWT；同一账号在手机、电脑、平板等任意设备使用同一套账号密码登录即可获得相同身份。
- **数据源统一**：企业、资讯、仪表盘、告警等均从后端 API 按当前用户拉取，所有设备看到的是同一份后端数据。
- **多端同时在线**：每个设备持有自己的 JWT，可同时登录；任意一端产生的变更（如添加企业、更新资料）会即时写入数据库，其他端刷新或下次请求即可看到最新结果。

**注意**：当前未实现「踢下线」或「单设备登录」；若需限制并发登录或强制下线，需在登录/签发 token 时增加额外逻辑（如记录设备/会话并校验）。

---

## 小结

| 能力           | 状态     | 说明                                       |
|----------------|----------|--------------------------------------------|
| 唯一身份识别   | 已实现   | 注册/登录/JWT + 企业归属 user_company_favorites |
| 信息安全       | 已实现   | 按用户隔离读写，密码哈希，JWT 签名         |
| 个性化服务     | 部分实现 | 用户设置、LLM 配置、收藏；主题等在前端本地 |
| 权限管理       | 已实现   | role：user/admin，admin_required 装饰器    |
| 跨端同步       | 已支持   | 多设备同账号登录，数据以后端为准           |

**从旧版本升级**：若数据库中已有企业数据但尚未写入 `user_company_favorites`，升级后对应用户的企业列表会为空。可执行一次性迁移：将需要保留的「我的企业」关联到对应用户，例如为管理员（如 `user_id=1`）关联全部已有企业：

```sql
INSERT OR IGNORE INTO user_company_favorites (user_id, company_id)
SELECT 1, id FROM companies;
```

生产部署时请务必：

- 设置强 `SECRET_KEY` 并启用 HTTPS；
- 关闭或严格限制 CORS；
- 定期备份数据库（如 `data/risk_platform.db`）；
- 如需更细粒度权限或审计，可在现有基础上扩展角色与日志。
