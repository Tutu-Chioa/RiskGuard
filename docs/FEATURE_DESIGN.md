# 功能设计与实现思路

本文档针对三项需求：① 文字/语音与大模型对话补充企业材料；② 新闻与法律风险统一量化；③ 云服务器上 MediaCrawler 扫码登录的解决思路。

---

## 一、尽调补充：文字 + 语音对话归集到企业

### 1.1 功能目标

作为客户经理尽调后，把网上查不到的信息（文字或语音）告诉大模型，由大模型自动整理并归集到**当前企业**的档案中（如补充到工商信息、风险备注、内部笔记等）。

### 1.2 放置位置建议

**主入口：企业详情页（CompanyDetail）**

- **理由**：对话天然需要「当前正在看哪家企业」的上下文，企业详情页已有基本信息、舆情、新闻、链接、文档等，在此增加「尽调补充 / AI 助手」最符合心智；无需先选企业再对话。
- **具体形态**：
  - 在企业详情页增加一个**可折叠区块**或**新 Tab**：「尽调补充」或「AI 助手」。
  - 区块内：多轮对话区域 + **文字输入框** + **语音输入按钮**（调用浏览器 Web Speech API 或后端语音识别）。
  - 每条用户输入带上 `company_id` 和已有企业摘要，大模型返回「结构化补充项」+ 自然语言摘要；后端根据结构化结果更新企业表或写入「补充材料」表。

**可选副入口**

- 在主导航或工作台增加「尽调助手」入口：先选企业，再进入与上述相同的对话界面（或直接跳转到该企业的详情页并展开「尽调补充」区块）。这样从列表或仪表盘也能快速进入。

### 1.3 数据与接口设计（概要）

- **存储**：
  - 方案 A：在 `companies` 表增加 `supplement_notes` / `internal_notes`（TEXT），大模型整理后的文本追加或替换。
  - 方案 B（推荐）：新建表 `company_supplements`（id, company_id, user_id, content_type, content, source_message_id, created_at），便于按条追溯、展示时间线；同时可保留在 `companies` 里一份「最新整理摘要」便于列表/详情头部展示。
- **接口**：
  - `POST /api/companies/:id/supplement-chat`  
    请求体：`{ "text": "用户输入文字" }` 或 `{ "audio_url": "语音文件临时 URL" }`（若语音在后端转写）。  
    后端：带当前企业 name、已有工商/舆情摘要等上下文调 LLM，LLM 返回结构化字段（如可写入的 key-value） + 自然语言总结；后端写库并返回总结与更新后的企业摘要。
  - 若语音在前端转写：前端用 Web Speech API 或接入语音识别服务得到文字，再只传 `text` 即可，无需改后端协议。

### 1.4 前端实现要点

- **语音输入**：优先使用浏览器 **Web Speech API（SpeechRecognition）** 做麦克风语音转文字，再将文字当普通消息发送；移动端/PC 均可用。若需更好识别效果，可后端接入第三方 ASR，接口改为支持 `multipart/form-data` 上传语音文件并返回转写文本，再由现有 `text` 接口提交。
- **对话展示**：简单列表即可，每条包含：角色（用户/助手）、内容、时间；助手内容可渲染「已归集到：注册资本、经营状态、内部备注」等简要说明。

---

## 二、新闻与法律风险统一量化

### 2.1 目标

让大模型对「相关新闻」和「法律风险」按**统一标准**进行评估，便于跨企业、跨时间对比和筛选。

### 2.2 统一评估维度建议

在现有 `risk_level`（低/中/高）、`sentiment_score`（-1～1）、`category` 基础上，增加**多维度量化**（可选逐步落地）：

| 维度         | 说明           | 取值建议                    |
|--------------|----------------|-----------------------------|
| 法律风险     | 涉诉、监管、合规 | 1–5 分 或 低/中/高          |
| 财务风险     | 债务、亏损、造假 | 1–5 分 或 低/中/高          |
| 经营风险     | 停业、裁员、业务收缩 | 1–5 分 或 低/中/高     |
| 舆情风险     | 声誉、负面舆论   | 1–5 分 或 低/中/高          |
| 综合风险等级 | 与现有 risk_level 一致 | 低 / 中 / 高           |
| 置信度       | 模型对评估的确信程度 | 0–1 或 低/中/高        |

可先统一为 **低/中/高** 三档，便于与现有 `risk_level` 兼容；若需要更细粒度再改为 1–5 分。

### 2.3 实现方式

- **Prompt 统一**：在 `llm_service` 中为「新闻分析」「法律/舆情分析」统一使用同一套说明与 JSON 输出格式，例如：
  - 输出字段：`risk_level`、`legal_risk`、`financial_risk`、`operational_risk`、`reputation_risk`、`confidence`、`summary`、`category`。
  - 明确约定：各维度仅允许枚举值（如 低/中/高），便于入库和筛选。
- **数据库**：
  - `company_news` 表已有 `risk_level`、`sentiment_score`、`category`；可新增列 `risk_dimensions`（TEXT/JSON），存 `{"legal_risk":"中","financial_risk":"低",...}`。
  - 法律案件、舆情条目若有独立表，同样增加 `risk_level` + 可选 `risk_dimensions`，与新闻共用同一套枚举。
- **前端**：企业详情、新闻/法律列表与详情中，除展示 `risk_level` 外，可展示各维度标签或小雷达图，便于快速判断「法律高、经营低」等。

### 2.4 与现有代码的衔接

- 当前 `llm_service` 中已有 `risk_level`、`sentiment_score`、`category` 的 prompt 与解析；扩展时在对应 prompt 中增加上述维度的说明与 JSON 字段，解析后写入 `risk_dimensions` 或单独字段。
- 新闻写入处（如 `app.py` 里插入 `company_news`）在插入时增加对 `risk_dimensions` 的写入（若为 JSON 字符串或单独列）。

---

## 三、云服务器上 MediaCrawler 扫码登录（PC / 移动端访问）

### 3.1 问题

MediaCrawler 爬取小红书等平台时使用 `--lt qrcode`，需扫码登录。云服务器无图形界面，无法在服务器本机扫码；用户通过 PC 或手机浏览器访问时，需要能在**网页上看到二维码并完成扫码**。

### 3.2 思路概览

| 方案 | 做法 | 优点 | 缺点 |
|------|------|------|------|
| A. Web 端展示二维码 | 后端启动登录流程并拿到二维码图片，通过 API 提供给前端展示；用户用手机/PC 打开页面扫码 | 一次部署，任意设备可扫码 | 需 MediaCrawler 或 Playwright 能输出二维码图片 |
| B. 本地扫码 + Cookie 上传 | 在本地/有桌面环境完成扫码，导出 cookie 上传到服务器 | 实现简单，不依赖服务器端浏览器 | 过期后需重新本地扫码并上传 |
| C. 隧道 + 远程桌面 | 服务器跑浏览器，通过 VNC/隧道把界面暴露给用户 | 灵活 | 架构重，维护成本高 |

**推荐**：优先实现 **A**；**B** 作为备用（例如在「平台登录」页提供「上传 Cookie」入口）。

### 3.3 方案 A：Web 端展示二维码（推荐）

- **流程**：
  1. 管理员在 Web 端打开「系统设置」→「平台登录」或「媒体爬虫登录」。
  2. 选择平台（如小红书），点击「生成登录二维码」。
  3. 后端启动 MediaCrawler 的登录流程（或单独 Playwright 脚本）：仅执行登录步骤，不执行爬取；若 MediaCrawler 支持将二维码输出为图片或到指定路径，则读取该图片；若不支持，可用 Playwright 在无头模式下访问登录页、截图二维码区域，保存为临时图片。
  4. 后端通过接口（如 `GET /api/mediacrawler/login-qrcode?platform=xhs`）返回二维码图片（或 Base64），或 SSE 推送二维码 URL；前端展示二维码。
  5. 用户用**手机打开小红书 APP** 扫描页面上的二维码，完成登录。
  6. 后端检测到登录成功（MediaCrawler/Playwright 的登录成功回调或轮询），将 session/cookie 持久化到服务器（如 `data/mediacrawler_sessions/xhs.json`），并通知前端「登录成功」。
  7. 后续爬取任务使用该 session，无需再次扫码，直到过期。

- **PC 与移动端**：任意设备浏览器访问同一「平台登录」页即可看到二维码；手机扫码通常用小红书 APP 扫，PC 上也可用手机扫，无需区分设备。

- **实现要点**：
  - 需确认 MediaCrawler 是否支持「仅登录并导出二维码」。若不支持，可用单独脚本：用 Playwright 打开小红书登录页，定位二维码元素并截图，将图片写到临时文件或内存，由 Flask 读入后 `send_file` 或 Base64 返回。
  - 登录过程可能需 30–60 秒，建议前端轮询 `GET /api/mediacrawler/login-status?platform=xhs`，待状态为「已登录」后提示成功并刷新爬虫状态。
  - 安全：登录相关接口需鉴权（仅管理员或登录用户），并考虑限流，避免滥用。

### 3.4 方案 B：本地扫码 + Cookie 上传（备用）

- 在本地或具备图形界面的机器上执行一次：
  ```bash
  cd MediaCrawler
  uv run main.py --platform xhs --lt qrcode --type search --keywords "测试"
  ```
  扫码完成后，从 MediaCrawler 的配置/数据目录中复制出 cookie 或 session 文件（具体路径参考 MediaCrawler 文档）。
- 在 Web「平台登录」页提供「上传 Cookie/登录态」：上传文件后，后端将文件保存到服务器的 `data/mediacrawler_sessions/` 下，并在调用 MediaCrawler 时通过环境变量或参数指定使用该 session。
- 缺点：cookie 过期后需再次在本地扫码并重新上传。

### 3.5 小结

- **尽调补充**：放在**企业详情页**，新增「尽调补充 / AI 助手」区块，支持文字 + 语音输入，对话结果归集到当前企业；可选在导航增加「尽调助手」跳转到企业并展开该区块。
- **新闻与法律风险量化**：在 LLM 中统一输出多维度风险（法律/财务/经营/舆情 + 综合 risk_level + 置信度），DB 增加 `risk_dimensions`（或等价字段），前后端按统一标准展示与筛选。
- **MediaCrawler 云上扫码**：优先做 **Web 端展示二维码**（后端生成二维码图片并接口返回，前端展示，用户任意设备扫码）；备用方案为本地扫码后 **上传 Cookie** 到服务器。

如需，我可以按上述方案拆成具体开发任务（后端接口、前端组件、DB 变更和 MediaCrawler 调用方式）并对应到仓库中的文件与函数。
