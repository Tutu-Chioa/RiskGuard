# 系统距离上线使用还差什么

本文从「必须」「强烈建议」「可选」三档，说明当前系统距离正式上线还缺哪些动作与配置。完成**必须**项并尽量完成**强烈建议**项后，即可视为具备上线条件。

---

## 一、必须完成（不做不宜上线）

### 1. 生产环境密钥

- **SECRET_KEY**：当前默认是 `your-secret-key-change-in-production`，**必须**在生产环境改为 32+ 位随机字符串，否则 JWT 可被伪造。
  - 在 `backend/.env` 中设置：`SECRET_KEY=你的随机长字符串`
  - 不要将 `.env` 或真实密钥提交到代码库。

### 2. 禁止清空数据库

- 生产首次启动时**必须**设置以下之一，否则会执行 DROP 表并插入示例数据，导致现有数据被清空：
  - `SKIP_DROP_TABLES=1`
  - 或 `FLASK_ENV=production`
- 启动示例：`SKIP_DROP_TABLES=1 npm run start:backend`（或在部署平台配置该环境变量）

### 3. HTTPS

- 对外访问**必须**使用 HTTPS，避免密码、Token 在传输中被窃听或篡改。
- 可用 Nginx / 云厂商负载均衡做 SSL 终结，或后端前加反向代理配 HTTPS；不推荐把 Flask 直接暴露公网。

### 4. 前端生产构建与 API 地址

- 使用 `npm run build:frontend` 生成生产包，用 `npm run start:server` 或 Nginx 等提供静态资源。
- 若前后端分离部署，需确保前端请求的 API 基地址指向实际后端域名/端口（当前通过 Node 代理到 8005 时无需改前端）。

---

## 二、强烈建议（安全与稳定性）

### 5. CORS 收紧

- 生产环境在 `backend/.env` 中设置：`CORS_ORIGINS=https://你的前端域名`（多个用逗号分隔）。
- 未设置时默认允许所有来源（仅适合开发）。

### 6. 数据库备份

- 系统已有**每日凌晨 2:00** 的自动备份（写入 `data/backup/`），并可通过「系统设置 → 安全设置」查看上次备份时间。
- 仍建议在服务器上额外用 cron 定期备份 `data/` 目录或整机快照，并测试恢复流程。

### 7. 管理员账号

- 使用脚本：`python backend/scripts/set_admin.py <用户名>` 将指定用户设为管理员。
- 或手动：`UPDATE users SET role='admin' WHERE username='xxx';`

### 8. 忘记密码 / 邮件（若需要）

- 忘记密码流程已实现；若希望用户通过邮件重置，需在**管理后台 → 系统设置**配置 SMTP 发件人，或在 `backend/.env` 中配置 `SMTP_*`、`RESET_PASSWORD_BASE_URL`。

---

## 三、可选（体验与运维）

### 9. 风险警报页与真实数据

- 风险警报页部分文案仍为写死；可改为完全对接 `GET /api/alerts` 与真实企业 ID，并让「处理/查看」跳转到对应企业。不影响登录与核心业务上线。

### 10. 监控与健康检查

- 已有 `GET /api/health`（或 HEAD）返回 200 表示服务与数据库可用，可供负载均衡或监控探测。
- 可按需接入 Sentry、日志聚合、告警等。

### 11. 从旧版升级

- 若数据库中已有企业数据但尚未写入 `user_company_favorites`，需执行一次性迁移（见 `docs/MULTI_USER_AND_PRODUCTION.md`），否则对应用户企业列表会为空。

---

## 四、已具备的能力（无需再补）

| 能力 | 说明 |
|------|------|
| 多用户与权限 | 注册/登录/JWT、按用户隔离数据、admin/user 角色、管理后台用户管理 |
| 安全 | 密码哈希、JWT 签名、限流（登录/注册/忘记密码）、生产错误不向前端暴露详情 |
| 两步验证 | TOTP 启用/关闭、登录二次验证、设置页二维码与验证码流程 |
| 自动备份 | 每日 2:00 备份 DB、`/api/backup/status`、设置页展示上次备份时间 |
| 忘记密码 | 前端入口与重置页、后端发重置邮件（需配置 SMTP） |
| 响应式 | 移动端/平板/PC 适配（侧栏抽屉、表单与表格适配） |

---

## 五、上线前自检表（可打勾）

- [ ] `SECRET_KEY` 已改为强随机值且未提交到代码库
- [ ] 生产启动已设置 `SKIP_DROP_TABLES=1` 或 `FLASK_ENV=production`
- [ ] 对外访问已启用 HTTPS
- [ ] 前端已生产构建并指向正确 API 地址
- [ ] CORS 已收紧：在 `.env` 中设置 `CORS_ORIGINS=https://你的前端域名`
- [ ] 已确认自动备份或额外 cron 备份在运行（可选：测试一次恢复）
- [ ] 如需管理员：已执行 `python backend/scripts/set_admin.py <用户名>`
- [ ] 若从旧版升级：已按需执行 `user_company_favorites` 迁移

完成上述**必须**项与**强烈建议**项后，系统即可上线使用；其余为体验与运维增强，可按迭代逐步补齐。
